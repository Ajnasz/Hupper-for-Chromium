<!DOCTYPE html>
<html>
  <head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <title>Hupper Extension Options</title>
    <style type="text/css">
      body {
          font-family: sans-serif;
      }
      label {
        margin-top: 10px;
      }
      #Content {
        width: 600px;
        margin: auto;
      }
      fieldset {
        border: 1px solid #000;
        margin: 10px 0;
      }
      table.tree {
          border-collapse: collapse;
          margin: 10px 0 20px;
          width: 100%;
      }
      table.tree > thead > tr > th {
          background-color: #eee;
          padding: 2px;
      }
      table.tree > thead > tr > th,
      table.tree > tbody > tr > td {
          border: 1px solid #999;
          height: 1em;
          padding: 2px 5px;
      }
      table.tree > tbody > tr > td > input {
        width: 100%;
      }

      button.save {
        /*
        background: -webkit-linear-gradient(#eee, #999 44%, #666);
        border: 1px solid #777;
        border-bottom: 1px solid #aaa;
        border-radius: 5px;
        box-shadow:inset 0 1px 0 0 #eee, 0px 1px 2px rgba(0,0,0,.2);
        color: #fff;
        */
        font-weight: bold;
        cursor: pointer;
        padding: 3px 10px;
        /* text-shadow: 0 -1px 0 #444; */
      }

      /*
      button.save:hover,
      button.save:focus {
        background: -webkit-linear-gradient(#FAFAFA, #AAA 44%, #666);
      }
      */

      #trollsTree td {
          width: 100%;
      }
      #highlightusersTree td {
          width: 50%;
      }
      #status {
          background: transparent;
          display: none;
          left: 0;
          padding: 10px;
          position: fixed;
          top: 0;
      }
    </style>
    <script type="text/javascript" src="chrome/content/hupper/namespace.js"></script>
    <script type="text/javascript" src="chrome/content/hupper/hp.js"></script>
    <script type="text/javascript" src="modules/HupEvent.jsm"></script>
    <script type="text/javascript" src="modules/treeView.jsm"></script>
    <script type="text/javascript">
    // Saves options to localStorage.

    var hp = new HP();
    var prefItems = [
        {id: 'enabletrollfilter', prefName: 'filtertrolls'},
        {id: 'trolls', prefName: 'trolls'},
        {id: 'trollcolor', prefName: 'trollcolor'},
        {id: 'trollfiltermethod', prefName: 'trollfiltermethod'},
        // {id: 'HUP-enable-hupperfilter', prefName: 'filterhuppers'},
        // {id: 'huppers', prefName: 'huppers'},
        // {id: 'HUP-hupper-color', prefName: 'huppercolor'},
        {id: 'enablenewcommentchange', prefName: 'replacenewcommenttext'},
        {id: 'newcommenttext', prefName: 'newcommenttext'},
        {id: 'extracommentlinks', prefName: 'extracommentlinks'},
        {id: 'hilightforumlinesonhover', prefName: 'hilightforumlinesonhover'},
        {id: 'insertpermalink', prefName: 'insertpermalink'},
        {id: 'insertnewtexttonode', prefName: 'insertnewtexttonode'},
        {id: 'fadeparentcomment', prefName: 'fadeparentcomment'},
        {id: 'showquicknavbox', prefName: 'showqnavbox'},
        {id: 'trollfilterHideanswers', prefName: 'hidetrollanswers'},
        {id: 'highlightusers', prefName: 'highlightusers'},
        {id: 'hidetaxonomy', prefName: 'hidetaxonomy'},
        {id: 'showinstatusbar', prefName: 'showinstatusbar'},
        {id: 'parseblocks', prefName: 'parseblocks'},
        {id: 'indent', prefName: 'styleIndent'},
        {id: 'accessibility', prefName: 'styleAccessibility'},
        {id: 'sidebarwidth', prefName: 'styleWiderSidebar'},
        {id: 'minfontsize', prefName: 'styleMinFontsize'},
        {id: 'setunlimitedlinks', prefName: 'setunlimitedlinks'},
        {id: 'boringcommentregexp', prefName: 'boringcommentcontents'},
        {id: 'highlightuserscolor', prefName: 'huppercolor'}
        // {id: 'HUP-hupper-password', prefName: 'getPassword'},
        // {id: 'HUP-hupper-username', prefName: 'username'}
    ];

    function getPrefNameForElem(elem) {
        var prefName = '';

        switch (elem.id) {

          case "enabletrollfilter":
            prefName = 'filtertrolls';
            break;
          case "trolls":
            prefName = 'trolls';
            break;
          case "trollcolor":
            prefName = 'trollcolor';
            break;
          case "trollfiltermethod":
            prefName = 'trollfiltermethod';
            break;
          case "trollfilterHideanswers":
            prefName = 'hidetrollanswers';
            break;
          case "huppers":
            prefName = 'huppers';
            break;
          case "enablenewcommentchange":
            prefName = 'extensions.hupper.replacenewcommenttext';
            break;
          case "newcommenttext":
            prefName = 'extensions.hupper.newcommenttext';
            break;
          case "extracommentlinks":
            prefName = 'extensions.hupper.extracommentlinks';
            break;
          case "hilightforumlinesonhover":
            prefName = 'extensions.hupper.hilightforumlinesonhover';
            break;
          case "insertpermalink":
            prefName = 'extensions.hupper.insertpermalink';
            break;
          case "insertnewtexttonode":
            prefName = 'extensions.hupper.insertnewtexttonode';
            break;
          case "fadeparentcomment":
            prefName = 'extensions.hupper.fadeparentcomment';
            break;
          case "showquicknavbox":
            prefName = 'extensions.hupper.showqnavbox';
            break;
          case "hidetaxonomy":
            prefName = 'extensions.hupper.hidetaxonomy';
            break;
          case "showinstatusbar":
            prefName = 'extensions.hupper.showinstatusbar';
            break;
          case "parseblocks":
            prefName = 'extensions.hupper.parseblocks';
            break;
          case "indent":
            prefName = 'extensions.hupper.style_indent';
            break;
          case "accessibility":
            prefName = 'extensions.hupper.style_accessibility';
            break;
          case "sidebarwidth":
            prefName = 'extensions.hupper.style_wider_sidebar';
            break;
          case "minfontsize":
            prefName = 'extensions.hupper.style_min_fontsize';
            break;
          case "highlightusers":
            prefName = "extensions.hupper.highlightusers";
            break;
          case "highlightuserscolor":
            prefName = "extensions.hupper.huppercolor";
            break;
          case "boringcommentregexp":
            prefName = "extensions.hupper.boringcommentcontents";
            break;
          case "setunlimitedlinks":
            prefName = "extensions.hupper.setunlimitedlinks";
            break;
        }
        return prefName;
    }
    function getFormElements() {
      var elements = document.getElementById('hupperOptsForm').elements;
      return Array.prototype.slice.call(elements);
    }
    function save_options() {
      var elements = getFormElements(),
          toSet = 0,
          set = 0;


      elements.forEach(function(elem) {
          var elemId = elem.id,
          nodeName = elem.nodeName.toUpperCase();
          if (nodeName === 'INPUT' || nodeName === 'SELECT' || nodeName === 'TEXTAREA') {
              var pref = prefItems.filter(function (item) {
                  return item.id === elemId;
              })[0];
              var value;
              if (elem.type && elem.type.toUpperCase() === 'CHECKBOX') {
                  value = elem.checked;
              } else {
                  value = elem.value;
              }
              toSet += 1;
              hp.set[pref.prefName](value, function (response) {
                  if (response.success) {
                      set += 1;
                      if (toSet === set) {
                          // Update status to let user know options were saved.
                          var st = document.getElementById('status');
                          st.innerHTML = 'Options Saved.';
                          st.style.display = 'block';
                          setTimeout(function() {
                              st.innerHTML = '';
                              st.style.display = '';
                          }, 1000);
                      }
                  }
              });
          }
      });

    }

    // Restores select box state to saved value from localStorage.
    function restore_options() {
      hp.get.trolls(function (response) {
          var field = document.getElementById('trolls');
          var trolls = response.pref.value.split(',').map(function (troll) {
            return {name: {text: troll, editable: true}};
          });
          var tree = new TreeView('trollsTree', trolls);
          var updateField = function () {
              field.value = trolls
                .map(function (troll) {
                  return troll.name.text;
                })
                .filter(function (troll) {
                      return troll !== '';
                  }).join(',');
          };
          var isEmpty = function (rowIndex) {
              return trolls[rowIndex].name.text === '';
          };
          tree.on('setCellText', function (o) {
              trolls[o.rowIndex][o.colName].text = o.value;
              var len = trolls.length;
              if (isEmpty(len - 1)) {
                  while (isEmpty(len - 2) && isEmpty(len - 1)) {
                      tree.removeLastRow();
                      len = trolls.length;
                  }
              } else {
                  tree.addEmptyRow();
              }
              updateField();
          });
          tree.on('removeRow', function (index) {
              var item = trolls.splice(index, 1);
              item = null;
          });
          tree.on('emptyRowAdded', function () {
              trolls[trolls.length] = {
                  name: {
                    text: '',
                    editable: true
                  }
              };
          });
          tree.addEmptyRow();
          field.type = 'hidden';
      });
      hp.get.highlightusers(function (response) {
          var field = document.getElementById('highlightusers');
          var highlightUsers = response.pref.value.split(',').map(function (user) {
            var item = user.split(':');
            return {name: {text: item[0], editable: true}, color: {text: item[1], editable: true}};
          });
          var tree = new TreeView('highlightusersTree', highlightUsers);
          var updateField = function () {
              var output = [];
              highlightUsers.forEach(function (user) {
                  if (user.name.text !== '' || user.color.text !== '') {
                      output.push(user.name.text + ':' + user.color.text);
                  }
              });
              field.value = output.join(',');
          }
          var isEmpty = function (rowIndex) {
              var row = highlightUsers[rowIndex];
              return row.name.text === '' && row.color.text === '';
          }
          tree.on('setCellText', function (o) {
              highlightUsers[o.rowIndex][o.colName].text = o.value;
              var len = highlightUsers.length;
              if (isEmpty(len - 1)) {
                    while (isEmpty(len - 2) && isEmpty(len - 1)) {
                        tree.removeLastRow();
                        len = highlightUsers.length;
                    }
              } else {
                  tree.addEmptyRow();
              }
              updateField();
          });
          tree.on('removeRow', function (index) {
              var item = highlightUsers.splice(index, 1);
              item = null;
          });
          tree.on('emptyRowAdded', function () {
              highlightUsers[highlightUsers.length] = {
                  name: {
                    text: '',
                    editable: true
                  },

                  color: {
                    text: '',
                    editable: true
                  }
              };
          });
          tree.addEmptyRow();
          field.type = 'hidden';
          // document.getElementById('highlightusersTree').appendChild(table);
      });
      var elements = getFormElements();
      elements.forEach(function(elem) {
          var elemId = elem.id,
              nodeName = elem.nodeName.toUpperCase();
          if (nodeName === 'INPUT' || nodeName === 'SELECT' || nodeName === 'TEXTAREA') {
              var pref = prefItems.filter(function (item) {
                  return item.id === elemId;
              })[0];
              hp.get[pref.prefName](function (response) {
                  if (response.success) {
                      var value = response.pref.value;
                    if (elem.type && elem.type.toUpperCase() === 'CHECKBOX') {
                        elem.checked = value;
                    } else {
                        elem.value = value;
                    }
                  }
              });
          }
      });
    }

    </script>
  </head>

<body onload="restore_options()">
      <div id="status"></div>
    <section id="Content">
      <h1>Settings for hupper</h1>
      <form action="" method="" onsubmit="return false;" id="hupperOptsForm">
        <fieldset>
          <legend>General</legend>
          <input type="checkbox" id="enablenewcommentchange">
          <label for="enablenewcommentchange">Enable to replace the 'Ãºj' text in the header of recently posted comments</label><br>

          <label for="newcommenttext">The text to replace to</label><br>
          <input type="input" id="newcommenttext"><br>

          <input type="checkbox" id="extracommentlinks">
          <label for="extracommentlinks"> Enable the top and back links in the comment footers</label><br>

          <input type="checkbox" id="hilightforumlinesonhover">
          <label for="hilightforumlinesonhover">Highlight forum lines on mouse over</label><br>

          <input type="checkbox" id="insertpermalink">
          <label for="insertpermalink">Insert permalink in the comment footers</label><br>

          <input type="checkbox" id="insertnewtexttonode">
          <label for="insertnewtexttonode">Insert the NEW text in the header of the articles where unread feeds are</label><br>

          <input type="checkbox" id="fadeparentcomment">
          <label for="fadeparentcomment">Fade parent comment</label><br>

          <input type="checkbox" id="showquicknavbox">
          <label for="showquicknavbox"> Show quick navigation box</label><br>

          <input type="checkbox" id="setunlimitedlinks">
          <label for="setunlimitedlinks">Show as many comments as possible on a page</label><br>

          <label for="hidetaxonomy">Hidable article types</label><br>
          <input type="input" id="hidetaxonomy"><br>


          <input type="checkbox" id="showinstatusbar">
          <label for="showinstatusbar">Show icon in statusbar</label><br>

          <input type="checkbox" id="parseblocks">
          <label for="parseblocks">Parse blocks</label><br>

          </fieldset>
          <fieldset>
            <legend>Trolls</legend>
            <input type="checkbox" id="enabletrollfilter">
            <label for="enabletrollfilter">Enable trollfilter</label><br>

            <input type="input" id="trolls">
            <div id="trollsTree"></div>

            <label for="trollcolor">The background color of the header of troll comments</label><br>
            <input type="input" id="trollcolor"><br>

            <p>
              <label for="trollfiltermethod">Effect to filter troll comments</label><br>
              <select id="trollfiltermethod">
                  <option>hide</option>
                  <option>highlight</option>
              </select><br>
            </p>
            <input type="checkbox" id="trollfilterHideanswers">
            <label for="trollfilterHideanswers">Hide answers to troll comments</label>
          </fieldset>
          <fieldset>
            <legend>Highlighted users</legend>
            <div id="highlightusersTree"></div>
            <label for="highlightuserscolor">Default highlight color:</label><br>
            <input type="input" id="highlightusers">
            <input type="input" id="highlightuserscolor">
          </fieldset>
          <fieldset>
            <input type="checkbox" id="indent">
            <label for="indent">Show line guide to the parent comment</label><br>
            <input type="checkbox" id="accessibility">
            <label for="accessibility">Load accesibility styles</label><br>
            <label for="sidebarwidth">Width of sidebars</label><br>
            <input type="text" id="sidebarwidth"><br>
            <label for="minfontsize">Minimum font size</label><br>
            <input type="text" id="minfontsize"><br>
          </fieldset>
          <fieldset>
            <label>Boring comment regexp</label><br />
            <input type="text" id="boringcommentregexp" />
          </fieldset>
        <button class="save" type="button" onclick="save_options()">Save</button>
      </form>
  </section>
</body>
</html>
